name: Version

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type (major/minor/patch) or \"skip\""
        required: false
        default: "skip"

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    concurrency:
      group: version-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check if version bump needed
        id: check
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            # First release: check all commits to determine initial version
            # This will create the first version tag based on all historical commits
            COMMITS=$(git log --oneline | grep -v "\[skip ci\]" | wc -l | tr -d ' ')
            echo "commits=$COMMITS" >> $GITHUB_OUTPUT
            echo "tag=none" >> $GITHUB_OUTPUT
          else
            # Check commits since last tag, filtering out [skip ci] commits
            # [skip ci] commits are typically docs-only changes that shouldn't trigger releases
            COMMITS=$(git log --oneline $LATEST_TAG..HEAD | grep -v "\[skip ci\]" | wc -l | tr -d ' ')
            echo "commits=$COMMITS" >> $GITHUB_OUTPUT
            echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

          echo "Commits to process: $COMMITS"

      - name: Bump version
        if: steps.check.outputs.commits != '0' && github.event.inputs.version != 'skip'
        run: |
          # Build bumpp command
          BUMP_CMD="bunx bumpp --yes --commit --tag --push"

          # Add version override if specified
          if [ "${{ github.event.inputs.version }}" != "" ] && [ "${{ github.event.inputs.version }}" != "skip" ]; then
            BUMP_CMD="$BUMP_CMD --release ${{ github.event.inputs.version }}"
          fi

          echo "Running: $BUMP_CMD"
          $BUMP_CMD

      - name: Verify version consistency
        if: steps.check.outputs.commits != '0' && github.event.inputs.version != 'skip'
        run: |
          # Ensure the created tag matches package.json version
          TAG_VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          JSON_VERSION=$(jq -r .version package.json)
          if [ "$TAG_VERSION" != "$JSON_VERSION" ]; then
            echo "Version mismatch: tag=$TAG_VERSION, package.json=$JSON_VERSION"
            exit 1
          fi
          echo "Version consistency verified: $TAG_VERSION"

      - name: Output result
        run: |
          if [ "${{ steps.check.outputs.commits }}" == "0" ]; then
            echo "No commits to process (all have [skip ci])"
          elif [ "${{ github.event.inputs.version }}" == "skip" ]; then
            echo "Versioning skipped via workflow_dispatch"
          else
            echo "Version bumped successfully"
          fi
